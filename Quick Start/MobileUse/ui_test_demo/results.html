<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>测试结果汇总</title>
<style>
body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:24px;color:#1f2937}
h1{font-size:22px;margin:0 0 12px}
.bar{display:flex;gap:12px;align-items:center;margin-bottom:16px;flex-wrap:wrap}
input[type=file]{padding:6px 10px;border:1px solid #cbd5e1;border-radius:0;font-size:14px}
button{height:32px;padding:6px 12px;border:1px solid #cbd5e1;background:#f8fafc;border-radius:0;cursor:pointer;font-size:14px}
button:hover{background:#eef2f7}
.bar select{height:32px;padding:6px 10px;border:1px solid #cbd5e1;border-radius:0;font-size:14px;background:#ffffff}
.stats{display:flex;gap:16px;flex-wrap:wrap;margin:16px 0}
.stat{background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:12px 14px}
.charts{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;margin:8px 0 16px}
.card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;background:#ffffff}
.card h2{margin:0 0 8px;font-size:16px}
canvas{width:100%;height:240px}
table{width:100%;border-collapse:collapse;margin-top:8px}
thead tr{background:#f1f5f9}
th,td{border:1px solid #e5e7eb;padding:8px;text-align:left;font-size:14px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
th.sortable{cursor:pointer}
.status-pass{color:#16a34a}
.status-fail{color:#dc2626}
.status-skip{color:#6b7280}
.grid{overflow:auto;max-height:60vh}
.empty{padding:12px;border:1px dashed #cbd5e1;border-radius:12px}
.pager{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.muted{color:#6b7280}

.cell-content{max-width:520px;cursor:pointer}
.cell-aosp{max-width:90px}
.cell-image-id{max-width:180px}
.cell-image-name{max-width:380px}
.cell-run-id{max-width:190px}
.cell-pod-id{max-width:190px}
.cell-task-status{max-width:120px}
.cell-cancel-ok{max-width:70px}
.cell-cancel-err{max-width:240px}

.modal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.55);z-index:9999}
.modal.hidden{display:none}
.modal-card{width:min(980px,92vw);max-height:88vh;display:flex;flex-direction:column;background:#ffffff;border-radius:14px;box-shadow:0 20px 60px rgba(0,0,0,.25)}
.modal-header{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid #e5e7eb}
.modal-title{font-size:14px;color:#111827;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.modal-actions{display:flex;gap:8px;align-items:center}
.modal-body{padding:12px 14px;overflow:auto}

.modal-tabs{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.modal-tab{height:30px;padding:6px 10px;border:1px solid #cbd5e1;background:#f8fafc;border-radius:999px;cursor:pointer;font-size:13px}
.modal-tab.active{background:#111827;color:#ffffff;border-color:#111827}

.modal-panel.hidden{display:none}

.modal-text{width:100%;min-height:42vh;max-height:68vh;resize:vertical;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;font-size:13px;line-height:1.45;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;white-space:pre-wrap}
.modal-hint{margin-top:8px;color:#6b7280;font-size:12px}

.json-tree{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:13px;line-height:1.45;border:1px solid #e5e7eb;border-radius:10px;padding:10px 12px;max-height:68vh;overflow:auto;background:#ffffff;white-space:pre-wrap}
</style>
</head>
<body>
<h1>Mobile Use For UI Test</h1>

<div class="bar">
  <input id="dir" type="file" webkitdirectory>
  <select id="fileSelect" multiple></select>
  <button id="loadSelected">加载所选</button>

  <input id="file" type="file" accept="application/json,.json" multiple>
  <button id="loadSample">加载示例</button>

  <span id="meta" class="muted"></span>
</div>

<div id="summary" class="stats"></div>

<div class="charts">
  <div class="card"><h2>状态分布</h2><canvas id="chartStatus"></canvas></div>
  <div class="card"><h2>失败原因分布</h2><canvas id="chartFailPie"></canvas></div>
  <div class="card"><h2>耗时直方图</h2><canvas id="chartHistogram"></canvas></div>
</div>

<div class="grid">
<table id="table">
<thead>
<tr>
  <th class="sortable" data-key="case">case</th>
  <th class="sortable" data-key="status">status</th>
  <th class="sortable" data-key="run_id">run_id</th>
  <th class="sortable" data-key="pod_id">pod_id</th>
  <th class="sortable" data-key="task_status">task_status</th>
  <th class="sortable" data-key="cancel_ok">cancel_ok</th>
  <th class="sortable" data-key="cancel_error_message">cancel_error_message</th>
  <th class="sortable" data-key="timestamp">timestamp</th>
  <th class="sortable" data-key="duration_ms">duration_ms</th>
  <th>reason</th>
  <th class="sortable" data-key="screenshot">screenshot</th>
  <th class="sortable" data-key="in_tokens">in_tokens</th>
  <th class="sortable" data-key="out_tokens">out_tokens</th>
  <th class="sortable" data-key="AospVersion">AospVersion</th>
  <th class="sortable" data-key="ImageId">ImageId</th>
  <th class="sortable" data-key="ImageName">ImageName</th>
  <th class="sortable" data-key="content">content</th>
</tr>
</thead>
<tbody></tbody>
</table>
</div>

<div id="contentModal" class="modal hidden" role="dialog" aria-modal="true" aria-label="content">
  <div class="modal-card">
    <div class="modal-header">
      <div id="contentModalTitle" class="modal-title">content</div>
      <div class="modal-actions">
        <button id="contentModalCopy" type="button">复制</button>
        <button id="contentModalClose" type="button">关闭</button>
      </div>
    </div>

    <div class="modal-body">
      <div class="modal-tabs">
        <button id="contentModalTabContent" class="modal-tab active" type="button">content</button>
        <button id="contentModalTabStruct" class="modal-tab" type="button">struct_output</button>
      </div>

      <div id="contentModalPanelContent" class="modal-panel">
        <textarea id="contentModalText" class="modal-text" readonly></textarea>
      </div>

      <div id="contentModalPanelStruct" class="modal-panel hidden">
        <div id="contentModalJson" class="json-tree"></div>
      </div>

      <div id="contentModalHint" class="modal-hint"></div>
    </div>
  </div>
</div>

<div class="pager">
  <button id="prev">上一页</button>
  <button id="next">下一页</button>
  <span id="pageInfo" class="muted"></span>
</div>

<div id="empty" class="empty">选择 results 目录中的 JSON 文件或点击“加载示例”。</div>

<script>
"use strict";

const input=document.getElementById('file');
const dir=document.getElementById('dir');
const fileSelect=document.getElementById('fileSelect');
const loadSelected=document.getElementById('loadSelected');
const tbody=document.querySelector('#table tbody');
const summary=document.getElementById('summary');
const empty=document.getElementById('empty');
const btn=document.getElementById('loadSample');
const meta=document.getElementById('meta');
const prev=document.getElementById('prev');
const next=document.getElementById('next');
const pageInfo=document.getElementById('pageInfo');
const chartStatus=document.getElementById('chartStatus');
const chartHistogram=document.getElementById('chartHistogram');
const chartFailPie=document.getElementById('chartFailPie');

let currentData=[];
let sortKey='timestamp';
let sortAsc=false;
let page=1;
let pageSize=100;
let dirFiles=[];

function normalize(input){
  if(Array.isArray(input))return input;
  if(input && Array.isArray(input.results))return input.results;
  return [];
}

function formatTs(ts){
  if(ts===null||ts===undefined)return '';
  return String(ts);
}

function stats(data){
  let pass=0,fail=0,skip=0;
  for(const i of data){
    const s=i.status;
    if(s==='pass')pass++;
    else if(s==='fail')fail++;
    else skip++;
  }
  return {total:data.length,pass,fail,skip};
}

function renderSummary(s){
  summary.innerHTML='';
  const nodes=[
    {k:'总数',v:s.total},
    {k:'通过',v:s.pass},
    {k:'失败',v:s.fail},
    {k:'跳过',v:s.skip},
  ];
  for(const n of nodes){
    const div=document.createElement('div');
    div.className='stat';
    div.textContent=n.k+': '+n.v;
    summary.appendChild(div);
  }
}

function setPixelRatio(canvas){
  const dpr=window.devicePixelRatio||1;
  const rect=canvas.getBoundingClientRect();
  canvas.width=Math.round(rect.width*dpr);
  canvas.height=Math.round(rect.height*dpr);
  return dpr;
}

function clearCanvas(canvas){
  const ctx=canvas.getContext('2d');
  if(!ctx)return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
}

function drawStatusChart(data){
  const c=chartStatus;
  const dpr=setPixelRatio(c);
  const ctx=c.getContext('2d');
  if(!ctx)return;
  clearCanvas(c);

  const s=stats(data);
  const items=[
    {k:'pass',v:s.pass,color:'#16a34a'},
    {k:'fail',v:s.fail,color:'#dc2626'},
    {k:'skip',v:s.skip,color:'#6b7280'},
  ];

  const pad=24*dpr;
  const w=c.width;
  const h=c.height;
  const barW=Math.max(16*dpr, (w-pad*2)/items.length*0.55);
  const maxV=Math.max(1,...items.map(x=>x.v));
  const base=h-pad*1.4;

  ctx.font=`${12*dpr}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif`;
  ctx.textAlign='center';
  ctx.textBaseline='bottom';

  items.forEach((it,idx)=>{
    const x=pad+(idx+0.5)*(w-pad*2)/items.length;
    const bh=(base-pad) * (it.v/maxV);
    ctx.fillStyle=it.color;
    ctx.fillRect(x-barW/2, base-bh, barW, bh);

    ctx.fillStyle='#111827';
    ctx.fillText(String(it.v), x, base-bh-6*dpr);

    ctx.textBaseline='top';
    ctx.fillStyle='#6b7280';
    ctx.fillText(it.k, x, base+6*dpr);
    ctx.textBaseline='bottom';
  });
}

function groupFailReasons(data){
  const m=new Map();
  for(const it of data){
    if(it.status!=='fail')continue;
    const r=(it.reason||'').trim()||'(无原因)';
    m.set(r,(m.get(r)||0)+1);
  }
  const arr=[...m.entries()].map(([k,v])=>({k,v}));
  arr.sort((a,b)=>b.v-a.v);
  return arr.slice(0,12);
}

function drawFailPie(data){
  const c=chartFailPie;
  const dpr=setPixelRatio(c);
  const ctx=c.getContext('2d');
  if(!ctx)return;
  clearCanvas(c);

  const items=groupFailReasons(data);
  const total=items.reduce((a,b)=>a+b.v,0);
  ctx.font=`${12*dpr}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif`;

  if(total<=0){
    ctx.fillStyle='#6b7280';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText('无失败数据', c.width/2, c.height/2);
    return;
  }

  const colors=['#dc2626','#ef4444','#f97316','#f59e0b','#84cc16','#22c55e','#14b8a6','#0ea5e9','#6366f1','#a855f7','#ec4899','#64748b'];
  const cx=c.width*0.32;
  const cy=c.height*0.52;
  const radius=Math.min(c.width,c.height)*0.28;

  let start=-Math.PI/2;
  items.forEach((it,idx)=>{
    const frac=it.v/total;
    const end=start+frac*2*Math.PI;
    ctx.beginPath();
    ctx.moveTo(cx,cy);
    ctx.arc(cx,cy,radius,start,end);
    ctx.closePath();
    ctx.fillStyle=colors[idx%colors.length];
    ctx.fill();
    start=end;
  });

  const lx=c.width*0.62;
  let ly=c.height*0.18;
  ctx.textAlign='left';
  ctx.textBaseline='middle';
  items.forEach((it,idx)=>{
    const y=ly+idx*18*dpr;
    ctx.fillStyle=colors[idx%colors.length];
    ctx.fillRect(lx, y-6*dpr, 10*dpr, 10*dpr);
    ctx.fillStyle='#111827';
    const txt=`${it.v} · ${it.k}`;
    ctx.fillText(txt, lx+14*dpr, y);
  });
}

function drawHistogram(data){
  const c=chartHistogram;
  const dpr=setPixelRatio(c);
  const ctx=c.getContext('2d');
  if(!ctx)return;
  clearCanvas(c);

  const durations=data.map(i=>Number(i.duration_ms||0)).filter(x=>isFinite(x)&&x>=0);
  if(durations.length===0){
    ctx.fillStyle='#6b7280';
    ctx.textAlign='center';
    ctx.textBaseline='middle';
    ctx.fillText('无耗时数据', c.width/2, c.height/2);
    return;
  }

  durations.sort((a,b)=>a-b);
  const min=durations[0];
  const max=durations[durations.length-1];
  const bins=12;
  const span=Math.max(1, max-min);
  const counts=new Array(bins).fill(0);
  for(const v of durations){
    const idx=Math.min(bins-1, Math.floor(((v-min)/span)*bins));
    counts[idx]++;
  }

  const pad=24*dpr;
  const w=c.width;
  const h=c.height;
  const base=h-pad*1.4;
  const maxC=Math.max(1,...counts);
  const bw=(w-pad*2)/bins;

  ctx.font=`${11*dpr}px system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif`;
  ctx.textAlign='center';
  ctx.fillStyle='#6b7280';
  ctx.fillText('ms', w-pad, pad*0.7);

  for(let i=0;i<bins;i++){
    const x=pad+i*bw;
    const bh=(base-pad) * (counts[i]/maxC);
    ctx.fillStyle='#0ea5e9';
    ctx.fillRect(x+1*dpr, base-bh, bw-2*dpr, bh);
  }

  ctx.fillStyle='#6b7280';
  ctx.textBaseline='top';
  ctx.fillText(String(Math.round(min)), pad, base+6*dpr);
  ctx.fillText(String(Math.round(max)), w-pad, base+6*dpr);
}

function comparableValue(item,k){
  const v=item?.[k];
  if(k==='duration_ms'||k==='in_tokens'||k==='out_tokens'){
    const n=Number(v||0);
    return isFinite(n)?n:0;
  }
  if(k==='cancel_ok'){
    if(v===true||v===1||v==='1'||v==='true')return 1;
    if(v===false||v===0||v==='0'||v==='false')return 0;
    return -1;
  }
  if(k==='AospVersion'){
    const n=Number(v);
    return isFinite(n)?n:String(v??'');
  }
  if(k==='screenshot'){
    if(Array.isArray(v))return v.length;
    if(typeof v==='string')return v.trim()?1:0;
    return 0;
  }
  if(k==='content'||k==='run_id'||k==='pod_id'||k==='task_status'||k==='cancel_error_message'){
    return String(v??'');
  }
  return String(v??'');
}

function sortData(){
  const cmp=(a,b)=>{
    let va=comparableValue(a,sortKey);
    let vb=comparableValue(b,sortKey);

    const na=typeof va==='number';
    const nb=typeof vb==='number';
    if(na && nb){
      if(va<vb)return sortAsc?-1:1;
      if(va>vb)return sortAsc?1:-1;
      return 0;
    }

    va=String(va??'');
    vb=String(vb??'');
    if(va<vb)return sortAsc?-1:1;
    if(va>vb)return sortAsc?1:-1;
    return 0;
  };
  currentData.sort(cmp);
}

function renderTable(){
  sortData();
  const total=currentData.length;
  const pages=Math.max(1,Math.ceil(total/pageSize));
  page=Math.min(page,pages);
  page=Math.max(page,1);

  const start=(page-1)*pageSize;
  const end=Math.min(total,start+pageSize);
  const frag=document.createDocumentFragment();

  for(let i=start;i<end;i++){
    const item=currentData[i];
    const tr=document.createElement('tr');

    const c=document.createElement('td');c.textContent=item.case??'';
    const s=document.createElement('td');s.textContent=item.status??'';s.className=item.status==='pass'?'status-pass':item.status==='fail'?'status-fail':'status-skip';

    const rid=document.createElement('td');rid.className='cell-run-id';
    const runId=String(item.run_id??'').trim();
    rid.textContent=runId;
    if(runId){rid.title=runId;}

    const pid=document.createElement('td');pid.className='cell-pod-id';
    const podId=String(item.pod_id??'').trim();
    pid.textContent=podId;
    if(podId){pid.title=podId;}

    const ts2=document.createElement('td');ts2.className='cell-task-status';
    const taskStatus=String(item.task_status??'').trim();
    ts2.textContent=taskStatus;
    if(taskStatus){ts2.title=taskStatus;}

    const cok=document.createElement('td');cok.className='cell-cancel-ok';
    const cancelOk=item.cancel_ok;
    if(cancelOk===true||cancelOk===1||cancelOk==='1'||cancelOk==='true'){cok.textContent='true';}
    else if(cancelOk===false||cancelOk===0||cancelOk==='0'||cancelOk==='false'){cok.textContent='false';}
    else{cok.textContent='';}

    const cerr=document.createElement('td');cerr.className='cell-cancel-err';
    const cancelErr=String(item.cancel_error_message??'').trim();
    cerr.textContent=cancelErr;
    if(cancelErr){cerr.title=cancelErr;}

    const t=document.createElement('td');t.textContent=formatTs(item.timestamp);
    const d=document.createElement('td');const dur=Number(item.duration_ms??0);d.textContent=isFinite(dur)?String(dur):'';
    const r=document.createElement('td');r.textContent=item.reason??'';

    const sc=document.createElement('td');
    const screenshotsArr=Array.isArray(item.screenshot)?item.screenshot.filter(x=>typeof x==='string'&&x.trim()):[];
    if(screenshotsArr.length>0){
      screenshotsArr.forEach((url,idx)=>{
        const u=String(url||'').trim();
        if(!u)return;
        if(idx>0){sc.appendChild(document.createTextNode(' '));}
        const a=document.createElement('a');
        a.href=u;
        a.target='_blank';
        a.rel='noopener noreferrer';
        a.textContent=screenshotsArr.length>1?`查看(${idx+1})`:'查看';
        sc.appendChild(a);
      });
    }

    const it=document.createElement('td');const inTok=Number(item.in_tokens??0);it.textContent=isFinite(inTok)&&inTok>0?String(inTok):'';
    const ot=document.createElement('td');const outTok=Number(item.out_tokens??0);ot.textContent=isFinite(outTok)&&outTok>0?String(outTok):'';

    const av=document.createElement('td');av.className='cell-aosp';
    const aosp=String(item.AospVersion??'').trim();
    av.textContent=aosp;
    if(aosp){av.title=aosp;}

    const iid=document.createElement('td');iid.className='cell-image-id';
    const imageId=String(item.ImageId??'').trim();
    iid.textContent=imageId;
    if(imageId){iid.title=imageId;}

    const inm=document.createElement('td');inm.className='cell-image-name';
    const imageName=String(item.ImageName??'').trim();
    inm.textContent=imageName;
    if(imageName){inm.title=imageName;}

    const ct=document.createElement('td');ct.className='cell-content';
    const rawContent=String(item.content??'');
    const oneLine=rawContent.replace(/\s+/g,' ').trim();
    const preview=oneLine.length>120?(oneLine.slice(0,120)+'…'):oneLine;
    ct.textContent=preview;
    ct.dataset.content=rawContent;
    try{ct.dataset.struct=JSON.stringify(item.struct_output??null);}catch(_){ct.dataset.struct='';}
    if(rawContent||item.struct_output){ct.title='点击查看/复制完整内容';}

    tr.appendChild(c);
    tr.appendChild(s);
    tr.appendChild(rid);
    tr.appendChild(pid);
    tr.appendChild(ts2);
    tr.appendChild(cok);
    tr.appendChild(cerr);
    tr.appendChild(t);
    tr.appendChild(d);
    tr.appendChild(r);
    tr.appendChild(sc);
    tr.appendChild(it);
    tr.appendChild(ot);
    tr.appendChild(av);
    tr.appendChild(iid);
    tr.appendChild(inm);
    tr.appendChild(ct);
    frag.appendChild(tr);
  }

  tbody.innerHTML='';
  tbody.appendChild(frag);
  pageInfo.textContent='第 '+page+' / '+Math.max(1,Math.ceil(total/pageSize))+' 页，共 '+total+' 条';
}

function renderAll(data,source){
  const arr = Array.isArray(data) ? data : normalize(data);
  if(arr.length===0){
    empty.style.display='block';
    currentData=[];
    tbody.innerHTML='';
    summary.innerHTML='';
    meta.textContent='';
    drawStatusChart([]);
    drawFailPie([]);
    drawHistogram([]);
    return;
  }

  empty.style.display='none';
  currentData=arr.map(i=>({
    case:String(i?.case??''),
    status:String(i?.status??''),
    run_id:String(i?.run_id??i?.RunId??''),
    pod_id:String(i?.pod_id??i?.PodId??''),
    task_status:String(i?.task_status??''),
    cancel_ok:(i?.cancel_ok??null),
    cancel_error_message:String(i?.cancel_error_message??''),
    timestamp:i?.timestamp??'',
    duration_ms:i?.duration_ms??0,
    reason:String(i?.reason??''),
    screenshot:(Array.isArray(i?.screenshot)
      ? i.screenshot
      : (typeof i?.screenshot==='string'&&String(i.screenshot).trim()? [String(i.screenshot).trim()] : [])),
    in_tokens:i?.in_tokens??0,
    out_tokens:i?.out_tokens??0,
    AospVersion:i?.AospVersion??'',
    ImageId:i?.ImageId??'',
    ImageName:i?.ImageName??'',
    content:i?.content??'',
    struct_output:i?.struct_output??null,
  }));

  const s=stats(currentData);
  renderSummary(s);
  drawStatusChart(currentData);
  drawFailPie(currentData);
  drawHistogram(currentData);

  const hint=source?('已加载：'+String(source)):'已加载';
  meta.textContent=hint+'，共 '+s.total+' 条';

  page=1;
  renderTable();
}

function readJsonFromFile(file){
  return new Promise((resolve,reject)=>{
    const fr=new FileReader();
    fr.onload=()=>{
      try{
        const txt=String(fr.result??'');
        const obj=JSON.parse(txt);
        resolve(obj);
      }catch(e){
        reject(e);
      }
    };
    fr.onerror=()=>reject(fr.error||new Error('FileReader error'));
    fr.readAsText(file,'utf-8');
  });
}

async function loadFiles(files,source){
  const arr=[];
  for(const f of files){
    try{
      const obj=await readJsonFromFile(f);
      if(Array.isArray(obj))arr.push(...obj);
      else if(obj && Array.isArray(obj.results))arr.push(...obj.results);
    }catch(_){
      continue;
    }
  }
  renderAll(arr,source);
}

function refreshDirSelect(list){
  fileSelect.innerHTML='';
  for(let i=0;i<list.length;i++){
    const f=list[i];
    const opt=document.createElement('option');
    opt.value=String(i);
    opt.textContent=f.webkitRelativePath||f.name||('file_'+i);
    fileSelect.appendChild(opt);
  }
}

// content/struct_output modal
const contentModal=document.getElementById('contentModal');
const contentModalTitle=document.getElementById('contentModalTitle');
const contentModalCopy=document.getElementById('contentModalCopy');
const contentModalClose=document.getElementById('contentModalClose');
const contentModalTabContent=document.getElementById('contentModalTabContent');
const contentModalTabStruct=document.getElementById('contentModalTabStruct');
const contentModalPanelContent=document.getElementById('contentModalPanelContent');
const contentModalPanelStruct=document.getElementById('contentModalPanelStruct');
const contentModalText=document.getElementById('contentModalText');
const contentModalJson=document.getElementById('contentModalJson');
const contentModalHint=document.getElementById('contentModalHint');

let modalActiveTab='content';
let modalLastContent='';
let modalLastStruct='';

function setModalTab(tab){
  modalActiveTab=tab;
  const isContent=tab==='content';

  contentModalTabContent.classList.toggle('active',isContent);
  contentModalTabStruct.classList.toggle('active',!isContent);

  contentModalPanelContent.classList.toggle('hidden',!isContent);
  contentModalPanelStruct.classList.toggle('hidden',isContent);
}

function renderStructText(text){
  const s=String(text??'').trim();
  if(!s){
    contentModalJson.textContent='(空)';
    return;
  }
  try{
    const obj=JSON.parse(s);
    contentModalJson.textContent=JSON.stringify(obj,null,2);
  }catch(_){
    contentModalJson.textContent=s;
  }
}

function openContentModal(title,rawContent,structText){
  modalLastContent=String(rawContent??'');
  modalLastStruct=String(structText??'');

  contentModalTitle.textContent=String(title||'content');
  contentModalText.value=modalLastContent;
  renderStructText(modalLastStruct);

  contentModalHint.textContent='点击“复制”复制当前 tab 内容；ESC 关闭';

  setModalTab('content');
  contentModal.classList.remove('hidden');
}

function closeContentModal(){
  contentModal.classList.add('hidden');
}

async function copyToClipboard(text){
  const s=String(text??'');
  try{
    await navigator.clipboard.writeText(s);
    contentModalHint.textContent='已复制到剪贴板';
  }catch(_){
    try{
      const ta=document.createElement('textarea');
      ta.value=s;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      contentModalHint.textContent='已复制到剪贴板';
    }catch(e){
      contentModalHint.textContent='复制失败：'+String(e?.message||e);
    }
  }
}

contentModalClose.addEventListener('click',closeContentModal);
contentModal.addEventListener('click',e=>{if(e.target===contentModal)closeContentModal();});
window.addEventListener('keydown',e=>{if(e.key==='Escape')closeContentModal();});

contentModalTabContent.addEventListener('click',()=>setModalTab('content'));
contentModalTabStruct.addEventListener('click',()=>setModalTab('struct'));

contentModalCopy.addEventListener('click',()=>{
  if(modalActiveTab==='content')copyToClipboard(modalLastContent);
  else copyToClipboard(modalLastStruct);
});

tbody.addEventListener('click',e=>{
  const el=e.target;
  if(!(el instanceof HTMLElement))return;
  const cell=el.closest('.cell-content');
  if(!cell)return;
  const title=String(cell.parentElement?.querySelector('td')?.textContent||'content');
  const raw=cell.dataset.content||'';
  const struct=cell.dataset.struct||'';
  openContentModal(title,raw,struct);
});

// Sorting
const thead=document.querySelector('#table thead');
if(thead){
  thead.addEventListener('click',e=>{
    const el=e.target;
    if(!(el instanceof HTMLElement))return;
    const th=el.closest('th.sortable');
    if(!th)return;
    const k=String(th.dataset.key||'');
    if(!k)return;
    if(sortKey===k)sortAsc=!sortAsc;
    else{sortKey=k;sortAsc=true;}
    page=1;
    renderTable();
  });
}

// Pager
prev.addEventListener('click',()=>{page=Math.max(1,page-1);renderTable();});
next.addEventListener('click',()=>{page=page+1;renderTable();});

// File inputs
input.addEventListener('change',()=>{
  const files=[...Array.from(input.files||[])].filter(f=>f&&String(f.name||'').toLowerCase().endsWith('.json'));
  if(files.length===0)return;
  loadFiles(files,files.length===1?files[0].name:(files.length+' files'));
});

dir.addEventListener('change',()=>{
  dirFiles=[...Array.from(dir.files||[])].filter(f=>String(f.name||'').toLowerCase().endsWith('.json'));
  refreshDirSelect(dirFiles);
});

loadSelected.addEventListener('click',()=>{
  const idxs=[...Array.from(fileSelect.selectedOptions||[])].map(o=>Number(o.value)).filter(n=>Number.isFinite(n));
  const files=idxs.map(i=>dirFiles[i]).filter(Boolean);
  if(files.length===0)return;
  loadFiles(files,files.length===1?(files[0].webkitRelativePath||files[0].name):(files.length+' files'));
});

const SAMPLE_DATA=[
  {
    case:'cases/sample.md',
    status:'fail',
    timestamp:'2026-01-01 00:00:00',
    duration_ms:1234,
    reason:'示例：未登录账号',
    screenshot:[],
    in_tokens:100,
    out_tokens:200,
    AospVersion:'13',
    ImageId:'img_xxx',
    ImageName:'sample',
    content:'示例 content',
    struct_output:{status:'fail',reason:'示例'},
    run_id:'123',
    pod_id:'456',
    task_status:'request_user',
    cancel_ok:false,
    cancel_error_message:'CancelTask Result 为空'
  }
];

btn.addEventListener('click',async()=>{
  try{
    const r=await fetch('results/sample.json',{cache:'no-store'});
    if(r.ok){
      const j=await r.json();
      renderAll(j,'results/sample.json');
      return;
    }
  }catch(_){
  }
  renderAll(SAMPLE_DATA,'内置示例');
});

// init
renderAll([],null);
</script>
</body>
</html>